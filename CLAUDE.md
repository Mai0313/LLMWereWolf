# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

LLM Werewolf is an AI-powered Werewolf (Mafia) game that supports multiple LLM models with a Terminal User Interface (TUI). The game implements complete Werewolf rules with 20+ roles, supporting mixed games with human players and AI agents.

## Key Commands

### Development Setup

```bash
# Install dependencies (requires uv package manager)
uv sync

# Install all groups including dev, test, docs
uv sync --all-groups

# Install specific dependency groups
uv sync --group dev         # Development tools
uv sync --group test        # Testing tools
uv sync --group docs        # Documentation generation
```

### Running the Game

```bash
# TUI Mode (interactive terminal interface)
uv run llm-werewolf-tui configs/demo.yaml           # Demo agents
uv run llm-werewolf-tui configs/players.yaml        # LLM agents
uv run llm-werewolf-tui configs/demo.yaml --debug   # With debug panel

# Console Mode (automatic text logs)
uv run llm-werewolf configs/demo.yaml
```

### Testing

```bash
# Run all tests with coverage
uv run pytest

# Run with coverage report
uv run pytest --cov=src --cov-report=term-missing

# Run specific test file
uv run pytest tests/core/test_roles.py -v

# Run specific test function
uv run pytest tests/core/test_roles.py::test_werewolf_role -v

# Run tests in parallel (faster)
uv run pytest -n auto
```

### Code Quality

```bash
# Run all pre-commit hooks (formatting, linting, type checking)
uv run pre-commit run -a
# Or use Makefile
make fmt

# Run Ruff linter check
uv run ruff check src/

# Auto-fix linting issues
uv run ruff check --fix src/

# Format code
uv run ruff format src/

# Type checking
uv run mypy src/
```

### Makefile Shortcuts

```bash
make clean      # Clean autogenerated files and caches
make fmt        # Run pre-commit hooks
make test       # Run all tests
```

## Architecture

The codebase is organized into three primary layers:

### 1. AI Layer (`src/llm_werewolf/ai/`)

Controls player agents (AI and human):

- **`agents.py`**: LLM agent implementation using OpenAI-compatible API, plus configuration models (`PlayerConfig`, `PlayersConfig`)

### 2. Core Game Logic (`src/llm_werewolf/core/`)

The heart of the Werewolf game implementation:

**Main Components:**

- **`game_engine.py`**: Orchestrates game flow (night/day/voting phases, victory checking)
- **`game_state.py`**: Manages current game state (players, round number, phase, death records)
- **`player.py`**: Player entity with role, status, and agent
- **`agent.py`**: Base agent protocol, `HumanAgent`, and `DemoAgent`

**Action System:**

- **`actions.py`**: Action definitions (`Action`, `VoteAction`, `WerewolfKillAction`, etc.)
- **`action_selector.py`**: AI-driven action selection logic using LLM

**Role System:**

- **`roles/base.py`**: Abstract `Role` base class
- **`roles/werewolf.py`**: Werewolf faction roles (Werewolf, AlphaWolf, WhiteWolf, WolfBeauty, etc.)
- **`roles/villager.py`**: Villager faction roles (Seer, Witch, Hunter, Guard, Cupid, etc.)
- **`roles/neutral.py`**: Neutral roles (Thief, Lover, WhiteLoverWolf)
- **`role_registry.py`**: Role registration and validation

**Configuration:**

- **`config/game_config.py`**: `GameConfig` model (player count, roles, timeouts)
- **`config/presets.py`**: Built-in presets (6/9/12/15-players, expert, chaos)

**Supporting Systems:**

- **`events.py`**: Event system for game logging (`Event`, `EventType`, `EventLogger`)
- **`victory.py`**: Victory condition checking (`VictoryChecker`)
- **`types.py`**: Type definitions (`Camp`, `GamePhase`, `ActionPriority`, `RoleConfig`)

### 3. UI Layer (`src/llm_werewolf/ui/`)

Terminal user interface built with Textual framework:

- **`tui_app.py`**: Main TUI application
- **`styles.py`**: TUI styling definitions
- **`components/`**: UI components (player_panel, game_panel, chat_panel, debug_panel)

### Entry Points

- **`cli.py`**: Console mode entry point (`llm-werewolf` command)
- **`tui.py`**: TUI mode entry point (`llm-werewolf-tui` command)

## Key Design Patterns

### Agent Protocol

All agents must implement:

- `model_name` (attribute): String identifier
- `get_response(message: str) -> str`: Synchronous message handling
- `reset()` (optional): Clear internal state between games

Built-in agent types:

1. **LLMAgent**: Uses OpenAI-compatible API for any LLM
2. **HumanAgent**: Terminal input for human players
3. **DemoAgent**: Random responses for testing

### Action System

Night actions are prioritized using `ActionPriority` enum:

1. Cupid (forms lovers)
2. Guard (protects)
3. Werewolves (kill)
4. Witch (heal/poison)
5. Seer (investigates)

Each role's `night_action()` method returns an `Action` object processed by `GameEngine`.

### Role Registration

All roles are automatically registered via `RoleRegistry`. To add a new role:

1. Create role class inheriting from `Role`
2. Implement `get_config()` returning `RoleConfig`
3. Implement `night_action()` if role acts at night
4. Import in `roles/__init__.py` to auto-register

### Configuration System

Game configuration via YAML files:

- **preset**: Selects role combination (e.g., "9-players", "expert")
- **show_debug**: Toggle debug panel in TUI
- **players**: List of player configurations with model, base_url, api_key_env

## Important Implementation Details

### Night Phase Flow

1. Set game phase to NIGHT
2. Get all alive players with roles that can act tonight
3. Sort by action priority
4. For each player, call role's `night_action()` method
5. Process werewolf team kill (consensus vote among werewolves)
6. Apply all actions (Guard protection, Witch abilities, etc.)
7. Resolve deaths and special triggers (AlphaWolf revenge, lover death chains, Hunter revenge)

### Day Phase Flow

1. Announce night deaths
2. Discussion phase (players generate discussion content via LLM)
3. Voting phase (each player votes to eliminate someone)
4. Execute voted player
5. Check for victory conditions

### Victory Conditions

Checked after each phase:

1. **Lovers Win**: Only two lovers remain (highest priority)
2. **Werewolf Win**: Werewolves ≥ Villagers
3. **Villager Win**: All werewolves eliminated

### Special Role Interactions

- **Elder**: Survives first attack, but if voted out, all villager abilities are disabled
- **Idiot**: Survives voting but loses voting rights
- **Hunter**: Can shoot someone when dying (except by Witch poison or voting)
- **AlphaWolf**: Takes someone with them when eliminated
- **WolfBeauty**: Charmed player dies if WolfBeauty dies
- **WhiteWolf**: Can kill another werewolf every other night to become lone wolf

## Testing Strategy

- Tests are in `tests/` directory mirroring `src/` structure
- Fixtures for common test scenarios (players, roles, game state)
- Test coverage minimum: 40% (configured in pyproject.toml)
- Tests run in parallel with pytest-xdist

## Code Style

- **Formatter**: Ruff (Google Python Style, 99 char line length)
- **Linter**: Ruff with extensive rule set
- **Type Hints**: Required for all functions (enforced by Ruff ANN rules)
- **Docstrings**: Google style, required for public APIs
- **Import Order**: isort via Ruff (standard library → third-party → first-party)

## Dependencies

Key dependencies:

- **pydantic** (≥2.12.3): Data validation and settings
- **textual** (≥6.3.0): TUI framework
- **rich** (≥14.2.0): Terminal formatting
- **openai** (≥2.5.0): LLM API client
- **python-dotenv** (≥1.1.1): Environment variables
- **pyyaml** (≥6.0.3): YAML config parsing
- **fire** (≥0.7.1): CLI interface
- **logfire** (≥4.13.2): Structured logging

## Environment Variables

Required for LLM agents (set in `.env` file):

```bash
OPENAI_API_KEY=sk-...       # OpenAI models
ANTHROPIC_API_KEY=sk-ant-...  # Anthropic Claude
DEEPSEEK_API_KEY=sk-...     # DeepSeek models
XAI_API_KEY=xai-...         # xAI Grok
# Local models (Ollama) don't need API keys
```

## Common Workflows

### Adding a New Role

1. Create role class in appropriate file (`roles/werewolf.py` or `roles/villager.py`)
2. Inherit from `Role` and implement required methods
3. Define `get_config()` with role's camp, priority, description
4. Implement `night_action()` if role acts at night
5. Add role name to a preset in `config/presets.py`
6. Add tests in `tests/core/test_roles.py`

### Adding a New Agent Type

1. Implement agent protocol (see "Agent Protocol" section)
2. Add agent factory logic in `ai/agents.py` `create_agent()` function
3. Update config validation if needed
4. Add tests in `tests/ai/test_base_agent.py`

### Debugging Game Logic

1. Use `--debug` flag with TUI mode to see debug panel
2. Check `EventLogger` output for action sequence
3. Use `show_debug: true` in YAML config
4. Add breakpoints in `game_engine.py` phase methods

## Known Limitations & TODO

See `TODO.md` for current development tasks. Key areas:

- Some special role abilities not fully implemented (see `rule.md`)
- Werewolf negotiation mechanism needs improvement
- Complex functions could be refactored for better testability
- Import structure could be simplified to avoid circular dependencies
